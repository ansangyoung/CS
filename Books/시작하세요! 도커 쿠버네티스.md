# 시작하세요! 도커/쿠버네티스  

### 용찬호 지음  

### 2.5 도커 데몬  
#### 2.5.1 도커의 구조  
a. 도커 명령어의 위치 확인  
which docker  
-> /usr/bin/docker  
-> 참고: 리눅스의 which 명령어는 명령어의 파일이 위치한 경로를 출력  
-> 의미: 도커 명령어는 /usr/bin/docker에 위치한 파일을 통해 사용되고 있음 . 즉, 컨테이너나 이미지를 다루는 명령어는 /usr/bin/docker에서 실행  

b. 실행 중인 도커 프로세스를 확인  
ps aux | grep docker  
-> USER  PID    %CPU  %MEM  VSZ     RSS    TT  STAT  START  TIME  COMMAND  
   root  20907  0.0   6.7   594500  68872  ?   Ssl   16:28  0:05  /usr/bin/dockerd -H fd://
-> 참고: ps aux 명령어는 실행 중인 프로세스의 목록을 출력 (CPU, MEM사용률, 프로세스 상태 코드 등 확인 가능.)  
-> 도커 엔진의 프로세스는 /usr/bin/dockerd 파일로 실행.(이는 docker 명령어가 실제 도커 엔진이 아닌 클라이언트로서의 도커이기 때문)  

c. 도커의 구조 (클라이언트로서의 도커 vs 서버로서의 도커)  
실제로 컨테이너를 생성하고 실행하며 이미지를 관리하는 주체는 도커 서버로, dockerd 프로세스로서 동작한다.  
도커 엔진은 외부에서 API 입력을 받아 도커 엔진의 기능을 수행하는데, 도커 프로세스가 실행되어 서버로서 입력을 받을 준비가 된 상태를 도커 데몬이라고 한다.  

도커 데몬은 API 입력을 받아 도커 엔진의 기능을 수행하는데, 이 API를 사용할 수 있도록 CLI를 제공하는 것이 도커 클라이언트이다.  

d. 도커 데몬을 제어하는 순서  
-> 사용자가 docker로 시작하는 명령어(예를들어, docker version)를 입력하면 도커 클라이언트를 사용하는 것이며, 도커 클라이언트는 입력된 명령어를 로컬에 존재하는 도커 데몬에게 API로서 전달.  
-> 도커 데몬은 이 명령어를 파싱하고, 명령어에 해당하는 작업을 수행하며, 수행 결과를 도커 클라이언트에게 반환하고 사용자에게 결과를 출력한다.  



### 2.5.2 도커 데몬 실행  
도커 데몬은 일반적으로 service 명령어로 시작, 정지할 수 있다.  
service docker start  
service docker stop  
우분투에서는 도커가 설치되면 자동으로 서비스로 등록되므로, 호스트가 재시작되더라도 자동으로 실행  
그러나, 레드햇 계열의 운영체제는 도커를 설치해도 자동으로 실행되도록 설정되지는 않는다.  
-> 이때, 도커를 자동으로 실행하도록 설정하려면 systemctl enable docker 와 같은 명령어로 docker 서비스를 활성화한다.  

또한, 서비스를 사용하지 않고 docker 입력으로 직접 도커데몬을 실행할 수 있다.  
실제 운영환경에서는 도커 데몬을 직접 실행하기보다는 service, systemctl 명령어를 통해 리눅스 서비스로서 관리하는 것이 좋다.  
-> 직접 도커 데몬을 실행하면 하나의 터미널을 차지하는 포그라운드 상태로 실행되기 때문에  


### 2.5.3 도커 데몬 설정  
#### 2.5.3.1 도커 데몬 제어: -H  
-H 옵션은 도커 데몬의 API를 사용할 수 있는 방법을 추가한다. 예를들어, -H에 IP 주소와 포트 번호를 입력하면 원격 API인 Docker Remote API로 도커를 제어할 수 있다.  
Remote API는 로컬에 있는 도커 데몬이 아니더라도 제어할 수 있으며, Restfull API 형식을 띠고 있으므로 HTTP 요청으로 도커를 제어할 수 있다.  
호스트의 모든 네트워크 인터페이스 카드에 할당된 IP 주소와 2375번 포트로 도커 데몬을 제어함과 동시에 도커 클라이언트도 사용할 수 있는 방법은 다음과 같다.  
dockerd -H unix:///var/run/docker.sock -H tcp://0.0.0.0:2375  

API에 따라서 사용하는 방법이 도커 명령어와 조금씩 다른 부분도 있으므로, HTTP 도구로 직접 API 요청을 전송하기보다는 특정 언어로 바인딩된 라이브러리를 사용하는 것이 일반적이다.  


#### 2.5.3.2 도커 데몬에 보안 적용: --tlsverify  
도커를 설치하면 기본적으로 보안 연결이 설정돼 있지 않다. 이는 도커 클라이언트, Remote API를 사용할 때 별도의 보안이 적용되지 않음을 의미한다.  


#### 2.5.3.3 도커 스토리지 드라이버 변경: --storage-difcer  
도커는 특정 스토리지 백엔드 기술을 사용해 도커 컨테이너와 이미지를 저장하고 관리한다.  


#### 2.5.3.4 컨테이너 저장 공간 설정  
컨테이너 내부에서 사용되는 파일시스템의 크기는 도커가 사용하고 있는 스토리지 드라이버에 따라 조금씩 다르다.  


### 2.5.4 도커 데몬 모니터링  
#### 2.5.4.1 도커 데몬 디버그 모드  
도커 데몬을 디버그모드로 실행하면, Remote API의 입출력뿐만 아니라 로컬 도커 클라이언트에서 오가는 모든 명령어를 로그로 출력한다.  
디버그모드는 도커 데몬을 실행할 때 -D 옵션을 추가해서 사용할 수 있다.  
그러나 로그에는 원하지 않는 정보까지 너무 많이 출력되며, 도커 데몬을 포그라운드 상태로 실행해야 한다는 단점이 있다.  


#### 2.5.4.2 events, stats, system df 명령어  
events  
도커 자체가 제공하는 기능이며, 도커가 기본으로 제공하는 명령어이다. docker events 또는 docker system events로 입력하면, 실시간 스트림 로그로 보여준다.  
다음 예는 이미지에 관한 로그만 출력하도록 설정하여 이미지에 관련된 명령어만 출력될 것이다.  
docker events --filter 'type=image'  


#### 2.5.4.3 CAdvisor  

### 2.5.5 Remote API 라이브러리를 이용한 도커 사용  

#### 2.5.5.1 자바 라이브러리  

#### 2.5.5.2 파이썬 라이브러리  

